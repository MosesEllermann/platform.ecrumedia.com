// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User roles
enum UserRole {
  ADMIN
  CLIENT
}

// User model - represents both clients and admins
model User {
  id                String   @id @default(cuid())
  email             String   @unique
  password          String
  role              UserRole @default(CLIENT)
  firstName         String
  lastName          String
  company           String?
  phone             String?
  address           String?
  postalCode        String?
  city              String?
  country           String   @default("Österreich")
  profileImage      String?  // URL or base64 encoded image
  
  // Company information (for admins as invoice issuer, for clients managed via Client model)
  vatNumber         String?  // UID for invoices
  homepage          String?  // Company website
  
  // Account status
  isActive          Boolean  @default(true)
  emailVerified     Boolean  @default(false)
  lastLogin         DateTime?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  invoices          Invoice[]
  quotes            Quote[]
  wordPressSites    WordPressSite[]
  hostingPlans      HostingPlan[]
  domains           Domain[]
  emailAccounts     EmailAccount[]
  auditLogs         AuditLog[]
  sessions          Session[]
  client            Client?  // One-to-one with Client profile
  
  @@map("users")
}

// Session model for JWT token management
model Session {
  id            String   @id @default(cuid())
  userId        String
  token         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

// Client type enum
enum ClientType {
  COMPANY    // Unternehmen
  PRIVATE    // Privatperson
}

// Client model - for invoice billing information
model Client {
  id            String      @id @default(cuid())
  clientNumber  Int         @unique // Auto-incrementing, but manually overridable
  type          ClientType  @default(COMPANY)
  
  // Basic information
  name          String      // Company name or person name
  vatNumber     String?     // UID - only for companies
  
  // Contact details
  address       String?
  countryCode   String      @default("AT") // ISO country code
  phone         String?
  email         String?
  homepage      String?
  
  // Additional notes
  fixedNote     String?     @db.Text
  
  // User account link (optional)
  userId        String?     @unique
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Relations
  invoices      Invoice[]
  quotes        Quote[]
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("clients")
}

// Quote model
enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  CONVERTED   // Converted to invoice
}

model Quote {
  id            String         @id @default(cuid())
  quoteNumber   String         @unique
  userId        String         // Keep for backward compatibility
  clientId      String?        // Reference to Client
  
  // Quote details
  issueDate     DateTime       @default(now())
  validUntil    DateTime       // Quote validity date
  status        QuoteStatus    @default(DRAFT)
  
  // Service period (Leistungszeitraum)
  servicePeriodStart DateTime?
  servicePeriodEnd   DateTime?
  
  // Financial information
  subtotal      Decimal        @db.Decimal(10, 2)
  taxRate       Decimal        @default(20) @db.Decimal(5, 2) // Austrian VAT 20%
  taxAmount     Decimal        @db.Decimal(10, 2)
  total         Decimal        @db.Decimal(10, 2)
  isReverseCharge Boolean      @default(false) // Reverse Charge for EU companies outside Austria
  
  // File storage
  pdfUrl        String?
  
  // Additional info
  notes         String?
  reverseChargeNote String?    // "Die Umsatzsteuerschuld geht auf den Leistungsempfänger über (Reverse Charge System)"
  
  // Conversion tracking
  convertedToInvoiceId String?  // Reference to created invoice if converted
  convertedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  user          User           @relation(fields: [userId], references: [id])
  client        Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  items         QuoteItem[]
  
  @@map("quotes")
}

// Quote items
model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  
  productName String?  // Optional product/service name
  description String
  quantity    Int      @default(1)
  unitName    String?  // e.g., "Stunde(n)", "Tag(e)", "Stück"
  unitPrice   Decimal  @db.Decimal(10, 2)
  taxRate     Decimal? @db.Decimal(5, 2) // Item-specific tax rate
  total       Decimal  @db.Decimal(10, 2)
  
  createdAt   DateTime @default(now())
  
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  @@map("quote_items")
}

// Invoice model
enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String         @id @default(cuid())
  invoiceNumber String         @unique
  userId        String         // Keep for backward compatibility
  clientId      String?        // New: reference to Client
  
  // Invoice details
  issueDate     DateTime       @default(now())
  dueDate       DateTime
  status        InvoiceStatus  @default(DRAFT)
  
  // Service period (Leistungszeitraum)
  servicePeriodStart DateTime?
  servicePeriodEnd   DateTime?
  
  // Financial information
  subtotal      Decimal        @db.Decimal(10, 2)
  taxRate       Decimal        @default(20) @db.Decimal(5, 2) // Austrian VAT 20%
  taxAmount     Decimal        @db.Decimal(10, 2)
  total         Decimal        @db.Decimal(10, 2)
  isReverseCharge Boolean      @default(false) // Reverse Charge for EU companies outside Austria
  
  // Payment information
  paidAt        DateTime?
  paidAmount    Decimal?       @db.Decimal(10, 2)
  
  // File storage
  pdfUrl        String?
  
  // Additional info
  notes         String?
  reverseChargeNote String?    // "Die Umsatzsteuerschuld geht auf den Leistungsempfänger über (Reverse Charge System)"
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  user          User           @relation(fields: [userId], references: [id])
  client        Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  items         InvoiceItem[]
  
  @@map("invoices")
}

// Invoice items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  
  productName String?  // Optional product/service name
  description String
  quantity    Int      @default(1)
  unitName    String?  // e.g., "Stunde(n)", "Tag(e)", "Stück"
  unitPrice   Decimal  @db.Decimal(10, 2)
  taxRate     Decimal? @db.Decimal(5, 2) // Item-specific tax rate
  total       Decimal  @db.Decimal(10, 2)
  
  createdAt   DateTime @default(now())
  
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

// WordPress sites
enum WordPressSiteStatus {
  ACTIVE
  SUSPENDED
  MAINTENANCE
  DELETED
}

model WordPressSite {
  id              String              @id @default(cuid())
  userId          String
  
  // Site details
  domain          String              @unique
  siteUrl         String
  adminUrl        String
  status          WordPressSiteStatus @default(ACTIVE)
  
  // Technical details
  phpVersion      String              @default("8.3")
  wordPressVersion String?
  storageUsed     Int                 @default(0) // in MB
  storageLimit    Int                 @default(5000) // in MB
  
  // Database info
  databaseName    String
  databaseUser    String
  
  // Server info
  serverIp        String?
  sslEnabled      Boolean             @default(false)
  sslExpiresAt    DateTime?
  
  // Backup info
  lastBackup      DateTime?
  backupEnabled   Boolean             @default(true)
  
  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  user            User                @relation(fields: [userId], references: [id])
  
  @@map("wordpress_sites")
}

// Hosting plans
enum HostingPlanType {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum HostingPlanStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
}

model HostingPlan {
  id                String             @id @default(cuid())
  userId            String
  
  // Plan details
  name              String
  type              HostingPlanType
  status            HostingPlanStatus  @default(ACTIVE)
  
  // Resources
  storageLimit      Int                // in MB
  bandwidthLimit    Int                // in GB per month
  databaseLimit     Int                @default(10)
  emailAccountLimit Int                @default(50)
  domainLimit       Int                @default(5)
  
  // Current usage
  storageUsed       Int                @default(0)
  bandwidthUsed     Int                @default(0)
  
  // Billing
  monthlyPrice      Decimal            @db.Decimal(10, 2)
  billingCycle      Int                @default(1) // in months
  
  // Dates
  startDate         DateTime           @default(now())
  renewalDate       DateTime
  expiresAt         DateTime?
  
  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  user              User               @relation(fields: [userId], references: [id])
  
  @@map("hosting_plans")
}

// Domains
enum DomainStatus {
  ACTIVE
  PENDING_TRANSFER
  EXPIRED
  SUSPENDED
  CANCELLED
}

model Domain {
  id              String        @id @default(cuid())
  userId          String
  
  // Domain details
  domainName      String        @unique
  status          DomainStatus  @default(ACTIVE)
  
  // Registration info
  registrar       String        @default("Hetzner")
  registeredAt    DateTime
  expiresAt       DateTime
  autoRenew       Boolean       @default(true)
  
  // DNS info - stored as JSON for MySQL compatibility
  nameservers     String        @db.Text
  
  // WHOIS protection
  whoisProtection Boolean       @default(false)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  user            User          @relation(fields: [userId], references: [id])
  dnsRecords      DnsRecord[]
  
  @@map("domains")
}

// DNS records
enum DnsRecordType {
  A
  AAAA
  CNAME
  MX
  TXT
  SRV
  NS
}

model DnsRecord {
  id          String        @id @default(cuid())
  domainId    String
  
  type        DnsRecordType
  name        String
  value       String
  ttl         Int           @default(3600)
  priority    Int?          // for MX records
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  domain      Domain        @relation(fields: [domainId], references: [id], onDelete: Cascade)
  
  @@map("dns_records")
}

// Email accounts
enum EmailAccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model EmailAccount {
  id              String             @id @default(cuid())
  userId          String
  
  // Email details
  email           String             @unique
  password        String             // encrypted
  status          EmailAccountStatus @default(ACTIVE)
  
  // Quota
  quotaLimit      Int                @default(5000) // in MB
  quotaUsed       Int                @default(0)
  
  // Forwarding
  forwardTo       String?
  
  // Autoresponder
  autoresponder   Boolean            @default(false)
  autoresponderMsg String?
  
  // Timestamps
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  user            User               @relation(fields: [userId], references: [id])
  
  @@map("email_accounts")
}

// Audit logs - for tracking admin actions (especially "Als Kunde einloggen")
enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_AS_CLIENT
  FAILED_LOGIN_AS_CLIENT_ATTEMPT
  CREATE_INVOICE
  DELETE_INVOICE
  CREATE_QUOTE
  DELETE_QUOTE
  CONVERT_QUOTE_TO_INVOICE
  CREATE_WORDPRESS_SITE
  DELETE_WORDPRESS_SITE
  UPDATE_USER
  UPDATE
  DELETE_USER
  CREATE_DOMAIN
  DELETE_DOMAIN
  CREATE_EMAIL
  DELETE_EMAIL
  UPDATE_HOSTING_PLAN
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String
  
  action      AuditAction
  targetId    String?     // ID of the affected resource
  targetType  String?     // Type of the affected resource (User, Invoice, etc.)
  details     Json?       // Additional details about the action
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime    @default(now())
  
  user        User        @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
}

