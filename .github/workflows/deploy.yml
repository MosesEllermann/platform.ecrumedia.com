name: Deploy to sPanel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_URL: https://platform.ecrumedia.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build Frontend
        env:
          VITE_API_URL: ${{ env.FRONTEND_URL }}
        run: |
          npm ci
          npm run build

      - name: Build Backend
        working-directory: ./backend
        env:
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
        run: |
          npm ci
          npx prisma generate
          npm run build

      - name: Deploy Frontend to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "dist/*"
          target: "/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com/"
          strip_components: 1
          rm: true

      - name: Deploy Backend to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "backend/dist,backend/package.json,backend/package-lock.json,backend/prisma"
          target: "/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com/backend/"
          strip_components: 1

      - name: Update Backend and Restart with PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          APP_PORT: ${{ secrets.APP_PORT }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          envs: DATABASE_URL,JWT_SECRET,APP_PORT,FRONTEND_URL
          script: |
            APP_ROOT="/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com"
            BACKEND_DIR="$APP_ROOT/backend"
            cd "$BACKEND_DIR"
            
            # Create .env file with required variables
            echo "Creating .env file..."
            cat > .env << EOF
            DATABASE_URL="$DATABASE_URL"
            JWT_SECRET="$JWT_SECRET"
            JWT_EXPIRES_IN="7d"
            PORT="$APP_PORT"
            NODE_ENV="production"
            FRONTEND_URL="$FRONTEND_URL"
            EOF
            
            echo "Installing dependencies..."
            npm ci --omit=dev
            
            # Install PM2 globally if not already installed
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              npm install -g pm2
            fi
            
            echo "Generating Prisma Client..."
            npx prisma generate
            
            echo "Running database migrations..."
            npx prisma migrate deploy
            
            echo "Updating API proxy rewrite rules..."
            cd "$APP_ROOT"
            cat > .htaccess << EOF
            RewriteEngine On
            RewriteRule ^api/(.*)$ http://127.0.0.1:$APP_PORT/api/\$1 [P,L]

            # Single Page Application fallback
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
            EOF
            cd "$BACKEND_DIR"

            echo "Starting/Restarting application with PM2..."
            # Stop existing PM2 process if running
            pm2 stop ecrumedia-backend || echo "No existing process to stop"
            pm2 delete ecrumedia-backend || echo "No existing process to delete"
            
            # Start the application with PM2
            pm2 start dist/main.js --name ecrumedia-backend --time
            
            # Save PM2 process list
            pm2 save
            
            # Setup PM2 to start on system boot (if not already done)
            pm2 startup || echo "PM2 startup already configured"
            
            echo "Deployment completed!"
            echo "Backend status:"
            pm2 status
