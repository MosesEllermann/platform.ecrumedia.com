name: Deploy to sPanel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_URL: https://platform.ecrumedia.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build Frontend
        env:
          VITE_API_URL: ${{ env.FRONTEND_URL }}
        run: |
          npm ci
          npm run build

      - name: Build Backend
        working-directory: ./backend
        env:
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
        run: |
          npm ci
          npx prisma generate
          npm run build

      - name: Deploy Frontend to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "dist/*"
          target: "/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com/"
          strip_components: 1
          rm: true

      - name: Deploy Backend to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "backend/dist,backend/package.json,backend/package-lock.json,backend/prisma,backend/app.yml"
          target: "/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com/backend/"
          strip_components: 1

      - name: Update Backend and Restart via sPanel API
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          APP_PORT: ${{ secrets.APP_PORT }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          envs: DATABASE_URL,JWT_SECRET,APP_PORT,FRONTEND_URL
          script: |
            APP_ROOT="/home/${{ secrets.SERVER_USER }}/platform.ecrumedia.com"
            BACKEND_DIR="$APP_ROOT/backend"
            cd "$BACKEND_DIR"
            trap 'echo "SIGTERM received during restart (expected). Continuing and exiting cleanly."; exit 0' TERM
            
            # Create .env file with required variables
            echo "Creating .env file..."
            cat > .env << EOF
            DATABASE_URL="$DATABASE_URL"
            JWT_SECRET="$JWT_SECRET"
            JWT_EXPIRES_IN="7d"
            PORT="$APP_PORT"
            NODE_ENV="production"
            FRONTEND_URL="$FRONTEND_URL"
            EOF
            
            echo "Installing dependencies..."
            npm ci --omit=dev
            
            echo "Generating Prisma Client..."
            npx prisma generate
            
            echo "Running database migrations..."
            npx prisma migrate deploy
            
            echo "Updating .htaccess for SPA routing..."
            cd "$APP_ROOT"
            cat > .htaccess << 'HTACCESS_END'
            RewriteEngine On
            
            # Single Page Application fallback
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
            HTACCESS_END
            
            echo "Created basic .htaccess:"
            cat .htaccess
            
            cd "$BACKEND_DIR"

            echo "Restarting application..."
            
            # Check if nodeapp command exists (sPanel CLI)
            if command -v nodeapp &> /dev/null; then
              echo "Using sPanel nodeapp CLI..."
              nodeapp restart ecrumedia-backend || nodeapp start ecrumedia-backend
            # Try Passenger-style restart (some sPanel versions use this)
            elif [ -d tmp ]; then
              echo "Using Passenger restart method..."
              mkdir -p tmp
              touch tmp/restart.txt
            # Try PM2 if available
            elif command -v pm2 &> /dev/null; then
              echo "Using PM2..."
              pm2 restart ecrumedia-backend || pm2 start dist/main.js --name ecrumedia-backend
              pm2 save
            # Fallback: start with node directly in background
            else
              echo "Starting with node directly..."
              pkill -f "node.*dist/main.js" || true
              nohup node dist/main.js > output.log 2>&1 &
              echo "Backend started. Check output.log for logs."
            fi
            
            echo "Deployment completed!"
            echo ""
            echo "=== DIAGNOSTICS ==="
            echo "1. Checking if backend is running on port $APP_PORT..."
            sleep 2
            
            # Test direct backend connection
            if curl -s http://127.0.0.1:$APP_PORT/api > /dev/null 2>&1; then
              echo "✅ Backend is responding at http://127.0.0.1:$APP_PORT/api"
              curl -s http://127.0.0.1:$APP_PORT/api
            else
              echo "❌ Backend NOT responding at http://127.0.0.1:$APP_PORT/api"
              echo "   Checking if process is running..."
              ps aux | grep "node.*dist/main.js" | grep -v grep || echo "   Process not found!"
            fi
            
            # Test what the public URL returns
            echo ""
            echo "2. Testing public API endpoint..."
            PUBLIC_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://platform.ecrumedia.com/api 2>&1)
            echo "   Public URL response code: $PUBLIC_RESPONSE"
            
            if [ "$PUBLIC_RESPONSE" = "200" ]; then
              echo "   ✅ Public API is working!"
            else
              echo "   ❌ Public API returned: $PUBLIC_RESPONSE"
              echo "   This means .htaccess proxy is NOT working"
              echo ""
              echo "3. Checking Apache modules..."
              apachectl -M 2>/dev/null | grep -i proxy || echo "   Proxy modules not found or can't check"
            fi
            
            echo ""
            echo "4. Current .htaccess content:"
            cat "$APP_ROOT/.htaccess"
            
            echo ""
            echo "5. Backend logs (last 30 lines):"
            tail -n 30 "$BACKEND_DIR/output.log" 2>/dev/null || echo "   No output.log found"
